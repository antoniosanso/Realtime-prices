name: Realtime Quote Extractor

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: "Percorso del file URL (es. urls.csv o Realtime-prices/urls.csv)"
        required: false
        default: "urls.csv"
      out_dir:
        description: "Cartella di output nel repo"
        required: false
        default: "webshots"
      viewport:
        description: "Viewport WxH"
        required: false
        default: "1366x768"
      delay_ms:
        description: "Ritardo extra prima dello scatto (ms)"
        required: false
        default: "1200"
      commit_outputs:
        description: "Committa gli output nel repo (yes/no)"
        required: false
        default: "yes"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      - name: Ensure output base dir exists
        run: |
          mkdir -p "${{ github.event.inputs.out_dir || 'webshots' }}"

      # Risolve automaticamente il path corretto di urls.csv (root o sottocartelle)
      - name: Resolve input path
        id: resolve
        shell: bash
        run: |
          set -e
          IN="${{ github.event.inputs.input_file || 'urls.csv' }}"
          if [ -f "$IN" ]; then
            echo "found=$IN" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          CAND=$(git ls-files | grep -i '/urls\.csv$' | head -n1 || true)
          if [ -z "$CAND" ]; then
            echo "âŒ urls.csv non trovato. Imposta l'input_file con il percorso corretto (es. Realtime-prices/urls.csv)." >&2
            exit 1
          fi
          echo "found=$CAND" >> "$GITHUB_OUTPUT"

      - name: Show input file (debug)
        shell: bash
        run: |
          echo "USING: ${{ steps.resolve.outputs.found }}"
          sed -n '1,50p' "${{ steps.resolve.outputs.found }}" || true

      - name: Run extractor
        shell: bash
        env:
          TIMEZONE: "Europe/Rome"
        run: |
          set -euxo pipefail
          python webshot_extract.py \
            --input "${{ steps.resolve.outputs.found }}" \
            --out   "${{ github.event.inputs.out_dir || 'webshots' }}" \
            --viewport "${{ github.event.inputs.viewport || '1366x768' }}" \
            --delay "${{ github.event.inputs.delay_ms || '1200' }}"
          echo "Extractor finished"

      - name: List outputs (debug)
        run: |
          echo "=== TREE ==="
          ls -R "${{ github.event.inputs.out_dir || 'webshots' }}" || true
          echo "==========="

      - name: Commit outputs (optional)
        if: ${{ github.event.inputs.commit_outputs == 'yes' }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          # ðŸ‘‰ committa sia la cartella webshots/ sia l'input urls.csv aggiornato
          git add "${{ github.event.inputs.out_dir || 'webshots' }}" "${{ steps.resolve.outputs.found }}" || true
          if ! git diff --cached --quiet; then
            git commit -m "webshot outputs & urls.csv update: ${GITHUB_RUN_ID}" || true
            git pull --rebase || true
            git push || true
          else
            echo "No changes to commit"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: webshot-${{ github.run_id }}
          path: |
            ${{ github.event.inputs.out_dir || 'webshots' }}
            ${{ steps.resolve.outputs.found }}
          if-no-files-found: warn
